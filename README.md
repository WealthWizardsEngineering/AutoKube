# AutoKube

Automatically apply configuration based on deployments.

This project uses [consul-template](https://github.com/hashicorp/consul-template) to generate configuration and invoke
the Kubernetes update.

AutoKube talks to consul, ideally this will be a local agent.

AutoKube talks to the Kubernetes API server via kubectl using basic username/password authentication.

* CONSUL_HTTP_ADDR (optional)
* CONSUL_HTTP_TOKEN
* CONTEXT
* KUBERNETES_API - e.g. https://api.my-custer
* KUBERNETES_USERNAME
* KUBERNETES_PASSWORD
* KUBERNETES_CERT - the API certificate to ensure secure communication

## Testing

Testing done by injecting test data into a consul server running locally and then generating the templates from that,
asserting against expected output files.

### Test data

Test data is injected into the consul server at start up from `test/data/consul.json`. This is a json representation of
the consul structure where the "value" is base64 encoded. This is the
[consul export](https://www.consul.io/docs/commands/kv/export.html) format and is imported using the
[consul import](https://www.consul.io/docs/commands/kv/import.html) command.

Test data is loaded before all tests, therefore is available for all tests.

Note that the consul service may not be terminated between runs and therefore may contain out of date test data,
particularly if data is removed from consul.json.

### Test contexts

Tests are run against a context/namespace, as this is how the tool is expected to be run.

A context is used to look up global configuration and is typically {namespace}-{clustername}, e.g. saturn-green-proof02,
where saturn-green is the namespace.

To add a new context create an directory in "test/expected_outputs" with the name of the new context and copy this
line, replacing "saturn-green-proof02" with the the new context:

```
runTestsFor "saturn-green-proof02" && RESULT=1
```

You will need to add appropriate test data to the test data file.

### Expected outputs

Tests are run against a namespace, the consul template output is asserted against the files in `test/expected_outputs`.

### Running tests

```
$ make test 
```

If a test fails, a diff between the expected output file and the file generated by consul template is shown. 