# AutoKube

Automatically apply configuration based on deployments.

This project uses [consul-template](https://github.com/hashicorp/consul-template) to generate configuration and invoke the Kubernetes update.

## Testing

Testing done by injecting test data into a consul server running locally and then generating the templates from that,
asserting against expected output files.

### Test data

Test data is injected into the consul server at start up from `test/data/consul.json`. This is a json representation of
the consul structure where the "value" is base64 encoded. This is the
[consul export](https://www.consul.io/docs/commands/kv/export.html) format and is imported using the
[consul import](https://www.consul.io/docs/commands/kv/import.html) command.

Test data is loaded before all tests, therefore is available for all tests.

Note that the consul service may not be terminated between runs and therefore may contain out of date test data,
particularly if data is removed from consul.json.

### Test namespaces

Tests are run against a namespace, as this is how the tool is expected to be run.

To add a new namespace create an directory in "test/expected_outputs" with the name of the new namespace and copy this
line, replacing "saturn-green" with the the new namespace:

```
runTestsFor "saturn-green" && RESULT=1
```

You will need to add appropriate test data to the test data file.

### Expected outputs

Tests are run against a namespace, the consul template output is asserted against the files in `test/expected_outputs`.

### Running tests

```
$ make test 
```

If a test fails, a diff between the expected output file and the file generated by consul template is shown. 

## Known limitations

* namespaces where config is stored in an aliased location in app_config_vars, e.g. st -> green.
* 